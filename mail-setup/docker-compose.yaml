services:
  # Internal DNS resolver
  resolver:
    image: ghcr.io/mailu/unbound:master
    container_name: mailu-resolver
    restart: always
    env_file: mailu.env
    networks:
      mailu-net:
        ipv4_address: 192.168.203.254

  # Mailu administration and API
  admin:
    image: ghcr.io/mailu/admin:master
    container_name: mailu-admin
    restart: always
    env_file: mailu.env
    volumes:
      - ./data:/data
    networks:
      - mailu-net
    dns:
      - 192.168.203.254

  # Webmail (Roundcube)
  webmail:
    image: ghcr.io/mailu/webmail:master
    container_name: mailu-webmail
    restart: always
    env_file: mailu.env
    volumes:
      - ./data/webmail:/data
    networks:
      - mailu-net
    dns:
      - 192.168.203.254

  # SMTP/IMAP services and Web Entry point
  front:
    image: ghcr.io/mailu/nginx:master
    container_name: mailu-front
    restart: always
    env_file: mailu.env
    ports:
      - "25:25"
      - "465:465"
      - "587:587"
      - "143:143"
      - "993:993"
    volumes:
      - ./data:/data
      - ./data/certs:/certs # Explicitly map certs
      - ./data/overrides:/overrides # Explicitly map overrides
    networks:
      - mailu-net
      - traefik-net
    dns:
      - 192.168.203.254
    labels:
      - "traefik.enable=true"
      # Admin UI
      - "traefik.http.routers.mailu-admin.rule=Host(`admin.bolann.cloud`)"
      - "traefik.http.routers.mailu-admin.tls=true"
      - "traefik.http.routers.mailu-admin.entrypoints=websecure"
      - "traefik.http.routers.mailu-admin.tls.certresolver=le"
      - "traefik.http.routers.mailu-admin.service=mailu-front-service"
      - "traefik.http.routers.mailu-admin.middlewares=mailu-admin-redirect"
      # Redirect admin.bolann.cloud/ to admin.bolann.cloud/admin/
      - "traefik.http.middlewares.mailu-admin-redirect.redirectregex.regex=^https://admin.bolann.cloud/$"
      - "traefik.http.middlewares.mailu-admin-redirect.redirectregex.replacement=https://admin.bolann.cloud/admin/"

      # Webmail
      - "traefik.http.routers.mailu-webmail.rule=Host(`webmail.bolann.cloud`)"
      - "traefik.http.routers.mailu-webmail.tls=true"
      - "traefik.http.routers.mailu-webmail.entrypoints=websecure"
      - "traefik.http.routers.mailu-webmail.tls.certresolver=le"
      - "traefik.http.routers.mailu-webmail.service=mailu-front-service"
      - "traefik.http.routers.mailu-webmail.middlewares=mailu-webmail-redirect"
      # Redirect webmail.bolann.cloud/ to webmail.bolann.cloud/webmail/
      - "traefik.http.middlewares.mailu-webmail-redirect.redirectregex.regex=^https://webmail.bolann.cloud/$"
      - "traefik.http.middlewares.mailu-webmail-redirect.redirectregex.replacement=https://webmail.bolann.cloud/webmail/"

      - "traefik.http.services.mailu-front-service.loadbalancer.server.port=80"
      - "traefik.docker.network=traefik_default"

  imap:
    image: ghcr.io/mailu/dovecot:master
    container_name: mailu-imap
    restart: always
    env_file: mailu.env
    volumes:
      - ./data:/data
    networks:
      - mailu-net
    dns:
      - 192.168.203.254

  smtp:
    image: ghcr.io/mailu/postfix:master
    container_name: mailu-smtp
    restart: always
    env_file: mailu.env
    volumes:
      - ./data:/data
    networks:
      - mailu-net
    dns:
      - 192.168.203.254

  antispam:
    image: ghcr.io/mailu/rspamd:master
    container_name: mailu-antispam
    restart: always
    env_file: mailu.env
    volumes:
      - ./data:/data
    networks:
      - mailu-net
    dns:
      - 192.168.203.254

  # Redis for session storage
  redis:
    image: redis:alpine
    container_name: mailu-redis
    restart: always
    command: redis-server --save "" --appendonly no
    volumes:
      - ./data/redis:/data
    networks:
      - mailu-net

networks:
  mailu-net:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.203.0/24
  traefik-net:
    external: true
    name: traefik_default
